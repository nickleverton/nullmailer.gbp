#!/bin/sh

set -e

. /lib/lsb/init-functions

PATH="/bin:/usr/bin:/sbin:/usr/sbin"
DAEMON="/usr/sbin/nullmailer-send"
ARGS="-d"

help () {
	echo "Usage: /etc/init.d/nullmailer { start | stop | restart | force-reload }" >&2
}

if [ ! -x "$DAEMON" ]; then
#	echo "Cannot execute nullmailer: program not found." >&2
#	exit 5 # LSB: program is not installed
	exit 0 # Debian policy: exit quietly, see #206928
fi

if [ "$2" ]; then
	help
	exit 2 # LSB: invalid or excess argument(s)
fi

case "$1" in
start)
	log_begin_msg "Starting mail-transport-agent: nullmailer..."
	if [ ! -c /var/spool/nullmailer/trigger ]; then
		rm -f /var/spool/nullmailer/trigger
		mkfifo /var/spool/nullmailer/trigger
	fi
	chown mail:root /var/spool/nullmailer/trigger
	chmod 0622 /var/spool/nullmailer/trigger
	start-stop-daemon --start --quiet --chuid mail --exec "$DAEMON" --oknodo -- $ARGS
	log_end_msg 0
	;;
stop)
	log_begin_msg "Stopping mail-transport-agent: nullmailer..."
	start-stop-daemon --stop --quiet --user mail --exec "$DAEMON" --oknodo
	log_end_msg 0
	;;
restart|force-reload)
	log_begin_msg "Restarting mail-transport-agent: nullmailer..."
	start-stop-daemon --stop --quiet --user mail --exec "$DAEMON" --oknodo
	start-stop-daemon --start --quiet --chuid mail --exec "$DAEMON" -- $ARGS
	log_end_msg 0
	;;
reload)
	help
	exit 3 # LSB: unimplemented feature
	;;
status)
	help
	exit 4 # LSB: program or service status is unknown
	;;
*)
	help
	exit 2 # LSB: invalid or excess argument(s)
esac

exit 0
