#! /bin/sh -e
if [ $# -ne 1 ]; then 
    echo >&2 "`basename $0`: script expects -patch|-unpatch as argument"
    exit 1  
fi
case "$1" in 
    -patch) patch -f --no-backup-if-mismatch -p1 < $0;;
    -unpatch) patch -f --no-backup-if-mismatch -R -p1 < $0;;
    *)
        echo >&2 "`basename $0`: script expects -patch|-unpatch as argument"
        exit 1;;
esac

exit 0

@DPATCH@
--- nullmailer-1.02/protocols/smtp.cc.orig	2006-06-25 02:50:39.000000000 +0100
+++ nullmailer-1.02/protocols/smtp.cc	2006-06-25 17:04:23.000000000 +0100
@@ -46,6 +46,7 @@
   void docmd(mystring cmd, int range, bool show_succ=false);
   void send_data(fdibuf* msg);
   void send_envelope(fdibuf* msg);
+  void send_quit();
   void send(fdibuf* msg);
 };
 
@@ -127,10 +128,16 @@
   docmd(".", 200, true);
 }
 
+void smtp::send_quit()
+{
+  docmd("QUIT", 200);
+}
+
 void smtp::send(fdibuf* msg)
 {
   send_envelope(msg);
   send_data(msg);
+  send_quit();
 }
 
 void protocol_prep(fdibuf*)
